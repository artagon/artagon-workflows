# Secure Gradle Configuration Templates

This directory contains templates for configuring Gradle projects with comprehensive supply-chain security features.

## Features

- **Dependency Locking**: Ensures reproducible builds by locking all dependency versions
- **Dependency Verification**: SHA-256 verification of all downloaded dependencies
- **Wrapper Integrity**: SHA-256 verification of the Gradle wrapper distribution
- **Repository Allow-listing**: Single trusted repository for all dependencies
- **SBOM Generation**: CycloneDX v1.6 Software Bill of Materials
- **No Dynamic Versions**: Enforces exact version specifications

## Quick Start

### 1. Copy Templates to Your Project

```bash
# Copy settings file
cp templates/gradle/settings.gradle.kts YOUR_PROJECT/settings.gradle.kts

# Copy build file
cp templates/gradle/build.gradle.kts YOUR_PROJECT/build.gradle.kts

# Copy wrapper properties
cp templates/gradle/gradle-wrapper.properties YOUR_PROJECT/gradle/wrapper/gradle-wrapper.properties
```

### 2. Configure Your Project

Edit the template files and replace these placeholders:

#### settings.gradle.kts
- `{{PROJECT_NAME}}` - Your project name
- `{{MIRROR_URL}}` - Your corporate mirror/proxy URL (e.g., `https://nexus.company.com/repository/maven-public/`)

#### build.gradle.kts
- `{{GROUP_ID}}` - Your group ID (e.g., `com.example`)
- `{{VERSION}}` - Your project version (e.g., `1.0.0`)
- `{{PROJECT_NAME}}` - Your project name
- `{{PROJECT_DESCRIPTION}}` - Project description
- `{{PROJECT_URL}}` - Project URL
- `{{LICENSE_NAME}}` - License name (e.g., `AGPL-3.0`)
- `{{LICENSE_URL}}` - License URL
- `{{DEVELOPER_ID}}` - Developer ID
- `{{DEVELOPER_NAME}}` - Developer name
- `{{DEVELOPER_EMAIL}}` - Developer email
- `{{GIT_URL}}` - Git repository URL
- `{{GITHUB_OWNER}}` - GitHub owner
- `{{GITHUB_REPO}}` - GitHub repository

### 3. Initialize Security Features

#### Generate Dependency Verification Metadata

```bash
# Generate SHA-256 verification metadata for all dependencies
./gradlew --write-verification-metadata sha256 help

# This creates gradle/verification-metadata.xml
```

#### Generate Dependency Lockfiles

```bash
# Generate lockfiles for all configurations
./gradlew dependencies --write-locks

# This creates *.lockfile files in your project
```

#### Verify Configuration

```bash
# Run the verification task
./gradlew verifySecureConfig

# Should output:
# ✅ Wrapper SHA-256 configured
# ✅ Dependency verification metadata found
# ✅ Found N lockfile(s)
# ✅ Configuration verification complete
```

### 4. Build with Verification

```bash
# Build with strict dependency verification
./gradlew clean build --verification-mode strict

# This will:
# - Verify all dependencies against verification-metadata.xml
# - Check lockfiles for drift
# - Generate SBOM (build/reports/bom.json)
```

## Workflow Integration

### Using gradle_build.yml

Create `.github/workflows/ci.yml`:

```yaml
name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    uses: artagon/artagon-workflows/.github/workflows/gradle_build.yml@main
    with:
      java-version: '25'
      verify-wrapper: true
      verify-dependencies: true
      check-lockfiles: true
```

### Using gradle_release.yml

Create `.github/workflows/release.yml`:

```yaml
name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    uses: artagon/artagon-workflows/.github/workflows/gradle_release.yml@main
    with:
      java-version: '25'
      generate-sbom: true
      validate-sbom: true
      convert-to-spdx: true
      sign-sbom: true
      create-github-release: true
    permissions:
      contents: write
      id-token: write
      attestations: write
```

## Configuration Details

### Repository Allow-listing

The `settings.gradle.kts` template configures `FAIL_ON_PROJECT_REPOS` mode, which means:

- ✅ All dependencies **must** come from repositories defined in `settings.gradle.kts`
- ❌ Individual build scripts **cannot** declare their own repositories
- ✅ Enforces centralized control over dependency sources

### Dependency Verification

The `gradle/verification-metadata.xml` file contains SHA-256 checksums for all dependencies:

```xml
<verification-metadata>
  <components>
    <component group="org.slf4j" name="slf4j-api" version="2.0.16">
      <artifact name="slf4j-api-2.0.16.jar">
        <sha256 value="..." origin="Generated by Gradle"/>
      </artifact>
    </component>
  </components>
</verification-metadata>
```

**Key points:**
- Generated automatically with `--write-verification-metadata`
- Enforced with `--verification-mode strict`
- Fails build if checksums don't match
- Should be committed to version control

### Dependency Locking

Lockfiles freeze transitive dependency versions:

```
# gradle.lockfile
org.slf4j:slf4j-api:2.0.16=runtimeClasspath
ch.qos.logback:logback-classic:1.5.15=runtimeClasspath
ch.qos.logback:logback-core:1.5.15=runtimeClasspath
```

**Key points:**
- Generated with `dependencies --write-locks`
- Prevents unexpected dependency updates
- Should be committed to version control
- Update with `dependencies --update-locks`

### Wrapper Integrity

The `gradle-wrapper.properties` includes a distribution checksum:

```properties
distributionSha256Sum=5313c32c68e98e6bd396d7c43a60ba729d47f8e8e10315eddb2be912aafde67e
```

**Key points:**
- Verifies the downloaded Gradle distribution
- Find checksums at https://gradle.org/release-checksums/
- CI workflows verify this before running
- Update when upgrading Gradle versions

### SBOM Generation

The build is configured to generate CycloneDX v1.6 SBOMs:

```kotlin
cyclonedxBom {
    schemaVersion.set("1.6")
    destination.set(file("build/reports"))
    outputFormat.set("all")  // JSON + XML
    includeBomSerialNumber.set(true)
    includeLicenseText.set(true)
}
```

**Output files:**
- `build/reports/bom.json` - CycloneDX JSON format
- `build/reports/bom.xml` - CycloneDX XML format

## Maintenance

### Updating Dependencies

1. **Update versions** in `build.gradle.kts`
2. **Regenerate verification metadata**:
   ```bash
   ./gradlew --write-verification-metadata sha256 help --refresh-dependencies
   ```
3. **Update lockfiles**:
   ```bash
   ./gradlew dependencies --write-locks
   ```
4. **Verify changes**:
   ```bash
   ./gradlew clean build --verification-mode strict
   ```
5. **Commit updated files**:
   ```bash
   git add gradle/verification-metadata.xml
   git add "*.lockfile"
   git commit -m "chore: update dependencies"
   ```

### Upgrading Gradle

1. **Update wrapper**:
   ```bash
   ./gradlew wrapper --gradle-version 8.12
   ```
2. **Get SHA-256 checksum** from https://gradle.org/release-checksums/
3. **Update `gradle/wrapper/gradle-wrapper.properties`**:
   ```properties
   distributionSha256Sum=<new-checksum>
   ```
4. **Test**:
   ```bash
   ./gradlew clean build --verification-mode strict
   ```

### Troubleshooting Verification Failures

If dependency verification fails:

```
> Dependency verification failed for configuration ':runtimeClasspath'
> Artifact slf4j-api-2.0.16.jar has incorrect checksum
```

**Resolution:**
1. Check if dependency was legitimately updated
2. If yes, regenerate metadata:
   ```bash
   ./gradlew --write-verification-metadata sha256 help --refresh-dependencies
   ```
3. If no, investigate potential supply-chain attack

### Troubleshooting Lockfile Drift

If lockfile drift is detected:

```
❌ Lockfile drift detected!
```

**Resolution:**
1. Review dependency changes
2. If expected, update lockfiles:
   ```bash
   ./gradlew dependencies --write-locks
   ```
3. Commit updated lockfiles

## CI/CD Integration

### Required Secrets

For publishing and signing:

```yaml
# GitHub Packages
GITHUB_TOKEN  # Automatically provided

# GPG Signing
GPG_PRIVATE_KEY   # Your GPG private key
GPG_PASSPHRASE    # Your GPG passphrase

# Optional: Repository credentials
MIRROR_USERNAME   # Corporate mirror username
MIRROR_PASSWORD   # Corporate mirror password
```

### Workflow Permissions

Required permissions for release workflows:

```yaml
permissions:
  contents: write      # Create releases
  packages: write      # Publish artifacts
  id-token: write      # OIDC for Cosign
  attestations: write  # Attest artifacts
```

## Security Best Practices

1. **Never use dynamic versions**: Always specify exact versions (no `+` or `latest`)
2. **Commit verification files**: `verification-metadata.xml` and `*.lockfile` should be in Git
3. **Review verification changes**: Carefully review changes to verification metadata
4. **Use HTTPS only**: `isAllowInsecureProtocol = false` for all repositories
5. **Pin wrapper version**: Always configure `distributionSha256Sum`
6. **Fail on drift**: Configure CI to fail on lockfile or verification drift
7. **Regular updates**: Update dependencies regularly and verify checksums
8. **Audit SBOMs**: Review generated SBOMs for unexpected dependencies

## Verification Commands

```bash
# Verify wrapper integrity
grep distributionSha256Sum gradle/wrapper/gradle-wrapper.properties

# Verify metadata exists
ls -la gradle/verification-metadata.xml

# Verify lockfiles exist
find . -name "*.lockfile"

# Full verification build
./gradlew clean build --verification-mode strict --refresh-dependencies

# Generate SBOM
./gradlew cyclonedxBom

# Check SBOM
ls -la build/reports/bom.*
```

## References

- [Gradle Dependency Verification](https://docs.gradle.org/current/userguide/dependency_verification.html)
- [Gradle Dependency Locking](https://docs.gradle.org/current/userguide/dependency_locking.html)
- [CycloneDX Gradle Plugin](https://github.com/CycloneDX/cyclonedx-gradle-plugin)
- [Sigstore Cosign](https://docs.sigstore.dev/cosign/overview/)
- [SLSA Framework](https://slsa.dev/)

## Support

For issues or questions:
- Open an issue: https://github.com/artagon/artagon-workflows/issues
- Related: #2 (Comprehensive SBOM workflows)
- Related: #14 (Secure Gradle workflows implementation)
