# Reusable CI Workflow for Rust Projects
#
# Automatically tested via artagon-workflow-test-rust on changes.
#
# Usage in your project's .github/workflows/ci.yml:
#
# name: CI
# on: [push, pull_request]
# jobs:
#   ci:
#     uses: artagon/artagon-workflows/.github/workflows/rust_ci.yml@main
#     with:
#       rust-version: 'stable'
#     secrets: inherit

name: Rust Project CI

on:
  workflow_call:
    inputs:
      rust-version:
        description: 'Rust toolchain version (stable, beta, nightly, or specific version)'
        required: false
        type: string
        default: 'stable'
      enable-clippy:
        description: 'Run clippy lints'
        required: false
        type: boolean
        default: true
      enable-rustfmt:
        description: 'Check code formatting'
        required: false
        type: boolean
        default: true
      enable-coverage:
        description: 'Generate code coverage'
        required: false
        type: boolean
        default: true
      cargo-features:
        description: 'Cargo features to enable (comma-separated)'
        required: false
        type: string
        default: ''
      cargo-args:
        description: 'Additional cargo arguments'
        required: false
        type: string
        default: ''

jobs:
  validate-inputs:
    name: Validate Inputs
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Check workflow inputs
        run: |
          set -euo pipefail

          RUST_VERSION="${{ inputs.rust-version }}"
          if ! echo "$RUST_VERSION" | grep -qE '^[A-Za-z0-9._-]+$'; then
            echo "Invalid rust-version: $RUST_VERSION"
            echo "Allowed characters: letters, numbers, dot, underscore, hyphen"
            exit 1
          fi

          FEATURES="${{ inputs.cargo-features }}"
          if [ -n "$FEATURES" ] && ! echo "$FEATURES" | grep -qE '^[A-Za-z0-9_,/ -]+$'; then
            echo "Invalid cargo-features: $FEATURES"
            echo "Allowed characters: letters, numbers, underscore, comma, slash, space, hyphen"
            exit 1
          fi

          CARGO_ARGS="${{ inputs.cargo-args }}"
          if [ -n "$CARGO_ARGS" ] && ! echo "$CARGO_ARGS" | grep -qE '^[A-Za-z0-9_.=/ -]+$'; then
            echo "Invalid cargo-args: $CARGO_ARGS"
            echo "Allowed characters: letters, numbers, underscore, dot, equals, slash, space, hyphen"
            exit 1
          fi

          echo "Input validation passed"

  build-test:
    name: Build and Test
    runs-on: ubuntu-latest
    needs: validate-inputs
    permissions:
      contents: read

    steps:
      - name: Checkout code
        # actions/checkout@v4.2.2
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Check for Nix
        id: check-nix
        run: |
          if [ -f "flake.nix" ]; then
            echo "has_nix=true" >> $GITHUB_OUTPUT
          else
            echo "has_nix=false" >> $GITHUB_OUTPUT
          fi

      - name: Install Nix
        if: steps.check-nix.outputs.has_nix == 'true'
        # cachix/install-nix-action@v31.9.0
        uses: cachix/install-nix-action@4e002c8ec80594ecd40e759629461e26c8abed15
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Set up Rust (non-Nix)
        if: steps.check-nix.outputs.has_nix == 'false'
        # dtolnay/rust-toolchain@stable
        uses: dtolnay/rust-toolchain@7b1c307e0dcbda6122208f10795a713336a9b35a
        with:
          toolchain: ${{ inputs.rust-version }}

      - name: Cache Cargo
        if: steps.check-nix.outputs.has_nix == 'false'
        # actions/cache@v4.2.0
        uses: actions/cache@1bd1e32a3bdc45362d1e726936510720a7c30a57
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ inputs.rust-version }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-${{ inputs.rust-version }}-
            ${{ runner.os }}-cargo-

      - name: Build (with Nix)
        if: steps.check-nix.outputs.has_nix == 'true'
        run: |
          FEATURES="${{ inputs.cargo-features }}"
          CARGO_ARGS="${{ inputs.cargo-args }}"
          FEATURE_ARG=""
          if [ -n "$FEATURES" ]; then
            FEATURE_ARG="--features $FEATURES"
          fi
          nix develop --command cargo build --verbose $FEATURE_ARG $CARGO_ARGS

      - name: Build (non-Nix)
        if: steps.check-nix.outputs.has_nix == 'false'
        run: |
          FEATURES="${{ inputs.cargo-features }}"
          CARGO_ARGS="${{ inputs.cargo-args }}"
          FEATURE_ARG=""
          if [ -n "$FEATURES" ]; then
            FEATURE_ARG="--features $FEATURES"
          fi
          cargo build --verbose $FEATURE_ARG $CARGO_ARGS

      - name: Run tests (with Nix)
        if: steps.check-nix.outputs.has_nix == 'true'
        run: |
          FEATURES="${{ inputs.cargo-features }}"
          CARGO_ARGS="${{ inputs.cargo-args }}"
          FEATURE_ARG=""
          if [ -n "$FEATURES" ]; then
            FEATURE_ARG="--features $FEATURES"
          fi
          nix develop --command cargo test --verbose $FEATURE_ARG $CARGO_ARGS

      - name: Run tests (non-Nix)
        if: steps.check-nix.outputs.has_nix == 'false'
        run: |
          FEATURES="${{ inputs.cargo-features }}"
          CARGO_ARGS="${{ inputs.cargo-args }}"
          FEATURE_ARG=""
          if [ -n "$FEATURES" ]; then
            FEATURE_ARG="--features $FEATURES"
          fi
          cargo test --verbose $FEATURE_ARG $CARGO_ARGS

  clippy:
    name: Clippy Lints
    runs-on: ubuntu-latest
    needs: validate-inputs
    if: inputs.enable-clippy
    permissions:
      contents: read

    steps:
      - name: Checkout code
        # actions/checkout@v4.2.2
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Check for Nix
        id: check-nix
        run: |
          if [ -f "flake.nix" ]; then
            echo "has_nix=true" >> $GITHUB_OUTPUT
          else
            echo "has_nix=false" >> $GITHUB_OUTPUT
          fi

      - name: Install Nix
        if: steps.check-nix.outputs.has_nix == 'true'
        # cachix/install-nix-action@v31.9.0
        uses: cachix/install-nix-action@4e002c8ec80594ecd40e759629461e26c8abed15
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Set up Rust (non-Nix)
        if: steps.check-nix.outputs.has_nix == 'false'
        # dtolnay/rust-toolchain@stable
        uses: dtolnay/rust-toolchain@7b1c307e0dcbda6122208f10795a713336a9b35a
        with:
          toolchain: ${{ inputs.rust-version }}
          components: clippy

      - name: Cache Cargo
        if: steps.check-nix.outputs.has_nix == 'false'
        # actions/cache@v4.2.0
        uses: actions/cache@1bd1e32a3bdc45362d1e726936510720a7c30a57
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-clippy-${{ inputs.rust-version }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-clippy-${{ inputs.rust-version }}-
            ${{ runner.os }}-cargo-

      - name: Run clippy (with Nix)
        if: steps.check-nix.outputs.has_nix == 'true'
        run: |
          FEATURES="${{ inputs.cargo-features }}"
          FEATURE_ARG=""
          if [ -n "$FEATURES" ]; then
            FEATURE_ARG="--features $FEATURES"
          fi
          nix develop --command cargo clippy $FEATURE_ARG -- -D warnings

      - name: Run clippy (non-Nix)
        if: steps.check-nix.outputs.has_nix == 'false'
        run: |
          FEATURES="${{ inputs.cargo-features }}"
          FEATURE_ARG=""
          if [ -n "$FEATURES" ]; then
            FEATURE_ARG="--features $FEATURES"
          fi
          cargo clippy $FEATURE_ARG -- -D warnings

  rustfmt:
    name: Format Check
    runs-on: ubuntu-latest
    needs: validate-inputs
    if: inputs.enable-rustfmt
    permissions:
      contents: read

    steps:
      - name: Checkout code
        # actions/checkout@v4.2.2
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Check for Nix
        id: check-nix
        run: |
          if [ -f "flake.nix" ]; then
            echo "has_nix=true" >> $GITHUB_OUTPUT
          else
            echo "has_nix=false" >> $GITHUB_OUTPUT
          fi

      - name: Install Nix
        if: steps.check-nix.outputs.has_nix == 'true'
        # cachix/install-nix-action@v31.9.0
        uses: cachix/install-nix-action@4e002c8ec80594ecd40e759629461e26c8abed15
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Set up Rust (non-Nix)
        if: steps.check-nix.outputs.has_nix == 'false'
        # dtolnay/rust-toolchain@stable
        uses: dtolnay/rust-toolchain@7b1c307e0dcbda6122208f10795a713336a9b35a
        with:
          toolchain: ${{ inputs.rust-version }}
          components: rustfmt

      - name: Check formatting (with Nix)
        if: steps.check-nix.outputs.has_nix == 'true'
        run: nix develop --command cargo fmt -- --check

      - name: Check formatting (non-Nix)
        if: steps.check-nix.outputs.has_nix == 'false'
        run: cargo fmt -- --check

  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    needs: validate-inputs
    if: inputs.enable-coverage
    permissions:
      contents: read

    steps:
      - name: Checkout code
        # actions/checkout@v4.2.2
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Check for Nix
        id: check-nix
        run: |
          if [ -f "flake.nix" ]; then
            echo "has_nix=true" >> $GITHUB_OUTPUT
          else
            echo "has_nix=false" >> $GITHUB_OUTPUT
          fi

      - name: Install Nix
        if: steps.check-nix.outputs.has_nix == 'true'
        # cachix/install-nix-action@v31.9.0
        uses: cachix/install-nix-action@4e002c8ec80594ecd40e759629461e26c8abed15
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Set up Rust (non-Nix)
        if: steps.check-nix.outputs.has_nix == 'false'
        # dtolnay/rust-toolchain@stable
        uses: dtolnay/rust-toolchain@7b1c307e0dcbda6122208f10795a713336a9b35a
        with:
          toolchain: ${{ inputs.rust-version }}

      - name: Install cargo-tarpaulin
        if: steps.check-nix.outputs.has_nix == 'false'
        run: cargo install cargo-tarpaulin

      - name: Cache Cargo
        if: steps.check-nix.outputs.has_nix == 'false'
        # actions/cache@v4.2.0
        uses: actions/cache@1bd1e32a3bdc45362d1e726936510720a7c30a57
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-coverage-${{ inputs.rust-version }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-coverage-${{ inputs.rust-version }}-
            ${{ runner.os }}-cargo-

      - name: Generate coverage (with Nix)
        if: steps.check-nix.outputs.has_nix == 'true'
        continue-on-error: true
        run: |
          FEATURES="${{ inputs.cargo-features }}"
          FEATURE_ARG=""
          if [ -n "$FEATURES" ]; then
            FEATURE_ARG="--features $FEATURES"
          fi
          nix develop --command cargo tarpaulin --out xml --output-dir coverage $FEATURE_ARG || true

      - name: Generate coverage (non-Nix)
        if: steps.check-nix.outputs.has_nix == 'false'
        continue-on-error: true
        run: |
          FEATURES="${{ inputs.cargo-features }}"
          FEATURE_ARG=""
          if [ -n "$FEATURES" ]; then
            FEATURE_ARG="--features $FEATURES"
          fi
          cargo tarpaulin --out xml --output-dir coverage $FEATURE_ARG || true

      - name: Upload to Codecov
        # codecov/codecov-action@v5.0.7
        uses: codecov/codecov-action@015f24e6818733317a2da2edd6290ab26238649a
        with:
          files: ./coverage/cobertura.xml
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}
