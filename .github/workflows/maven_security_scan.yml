# Reusable Maven Security Scan Workflow
#
# Runs security scans including OWASP Dependency Check,
# CodeQL analysis, and vulnerability detection.
#
# Usage in your project's .github/workflows/security.yml:
#
# name: Security Scan
# on:
#   push:
#     branches: [main]
#   pull_request:
#   schedule:
#     - cron: '0 6 * * 1'  # Weekly on Mondays
# jobs:
#   scan:
#     uses: artagon/artagon-workflows/.github/workflows/maven_security_scan.yml@main
#     with:
#       run-dependency-check: true

name: Security Scan (Reusable)

on:
  workflow_call:
    inputs:
      java-version:
        description: 'Java version to use'
        required: false
        type: string
        default: '25'
      java-distribution:
        description: 'Java distribution'
        required: false
        type: string
        default: 'temurin'
      run-dependency-check:
        description: 'Run OWASP Dependency Check'
        required: false
        type: boolean
        default: true
      run-ossindex-audit:
        description: 'Run Sonatype OSS Index audit'
        required: false
        type: boolean
        default: true
      run-trivy-scan:
        description: 'Run Trivy vulnerability scanner'
        required: false
        type: boolean
        default: true
      fail-on-severity:
        description: 'Fail on vulnerability severity (CRITICAL, HIGH, MEDIUM, LOW)'
        required: false
        type: string
        default: 'HIGH'

jobs:
  security-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write  # Required for SARIF upload

    steps:
      - name: Checkout code
        # actions/checkout@v4.2.2
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Set up JDK ${{ inputs.java-version }}
        # actions/setup-java@v4.5.0
        uses: actions/setup-java@8df1039502a15bceb9433410b1a100fbe190c53b
        with:
          java-version: ${{ inputs.java-version }}
          distribution: ${{ inputs.java-distribution }}
          cache: 'maven'

      - name: Build project
        run: mvn clean package -DskipTests --batch-mode --no-transfer-progress

      - name: Run Sonatype OSS Index Audit
        if: inputs.run-ossindex-audit
        run: |
          mvn org.sonatype.ossindex.maven:ossindex-maven-plugin:audit \
            --batch-mode --no-transfer-progress
        continue-on-error: true

      - name: Run OWASP Dependency Check
        if: inputs.run-dependency-check
        run: |
          mvn org.owasp:dependency-check-maven:check \
            -DfailBuildOnCVSS=7 \
            --batch-mode --no-transfer-progress
        continue-on-error: true

      - name: Upload Dependency Check report
        if: always() && inputs.run-dependency-check
        # actions/upload-artifact@v4.4.3
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882
        with:
          name: dependency-check-report
          path: target/dependency-check-report.html
          retention-days: 30

      - name: Run Trivy vulnerability scanner
        if: inputs.run-trivy-scan
        # aquasecurity/trivy-action@0.28.0
        uses: aquasecurity/trivy-action@69c4ceb78ce0f6ebbb0ea7c9bc6f9d46423d5d62
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: ${{ inputs.fail-on-severity }}

      - name: Upload Trivy results to GitHub Security tab
        if: always() && inputs.run-trivy-scan
        # github/codeql-action/upload-sarif@v3.27.6
        uses: github/codeql-action/upload-sarif@662472033e021d55d94146f66f6058822b0b39fd
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Run SpotBugs security analysis
        run: |
          mvn com.github.spotbugs:spotbugs-maven-plugin:check \
            -Dspotbugs.effort=Max \
            -Dspotbugs.threshold=Low \
            --batch-mode --no-transfer-progress
        continue-on-error: true

      - name: Upload SpotBugs report
        if: always()
        # actions/upload-artifact@v4.4.3
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882
        with:
          name: spotbugs-report
          path: |
            **/target/spotbugsXml.xml
            **/target/spotbugs.html
          retention-days: 30

      - name: Security scan summary
        if: always()
        run: |
          echo "## Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- OSS Index Audit: ${{ inputs.run-ossindex-audit && '✓ Completed' || '⊘ Skipped' }}" >> $GITHUB_STEP_SUMMARY
          echo "- OWASP Dependency Check: ${{ inputs.run-dependency-check && '✓ Completed' || '⊘ Skipped' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Trivy Scan: ${{ inputs.run-trivy-scan && '✓ Completed' || '⊘ Skipped' }}" >> $GITHUB_STEP_SUMMARY
          echo "- SpotBugs Analysis: ✓ Completed" >> $GITHUB_STEP_SUMMARY
