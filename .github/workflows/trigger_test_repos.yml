# Trigger Test Repositories
#
# This workflow triggers CI in all test repositories when workflows are updated
# or releases are published, ensuring test repos validate the latest changes.

name: Trigger Test Repositories

on:
  release:
    types: [published]
  push:
    branches: [main]
    paths:
      - '.github/workflows/*.yml'
      - '.github/workflows/*.yaml'
  workflow_dispatch:
    inputs:
      event_type:
        description: 'Event type to send to test repos'
        required: false
        default: 'workflow-updated'
        type: choice
        options:
          - workflow-updated
          - release-published

permissions:
  contents: read

jobs:
  trigger-maven:
    name: Trigger Maven Test Repo
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Trigger artagon-workflow-test-maven
        run: |
          EVENT_TYPE="${{ inputs.event_type || 'workflow-updated' }}"
          if [ "${{ github.event_name }}" = "release" ]; then
            EVENT_TYPE="release-published"
          fi

          echo "Triggering artagon-workflow-test-maven with event: $EVENT_TYPE"

          gh api repos/artagon/artagon-workflow-test-maven/dispatches \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -f "event_type=$EVENT_TYPE" \
            -f "client_payload[repository]=${{ github.repository }}" \
            -f "client_payload[ref]=${{ github.ref }}" \
            -f "client_payload[sha]=${{ github.sha }}"
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_DISPATCH_TOKEN }}

  trigger-cmake:
    name: Trigger CMake Test Repo
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Trigger artagon-workflow-test-cmake
        run: |
          EVENT_TYPE="${{ inputs.event_type || 'workflow-updated' }}"
          if [ "${{ github.event_name }}" = "release" ]; then
            EVENT_TYPE="release-published"
          fi

          echo "Triggering artagon-workflow-test-cmake with event: $EVENT_TYPE"

          gh api repos/artagon/artagon-workflow-test-cmake/dispatches \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -f "event_type=$EVENT_TYPE" \
            -f "client_payload[repository]=${{ github.repository }}" \
            -f "client_payload[ref]=${{ github.ref }}" \
            -f "client_payload[sha]=${{ github.sha }}"
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_DISPATCH_TOKEN }}

  trigger-bazel:
    name: Trigger Bazel Test Repo
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Trigger artagon-workflow-test-bazel
        run: |
          EVENT_TYPE="${{ inputs.event_type || 'workflow-updated' }}"
          if [ "${{ github.event_name }}" = "release" ]; then
            EVENT_TYPE="release-published"
          fi

          echo "Triggering artagon-workflow-test-bazel with event: $EVENT_TYPE"

          gh api repos/artagon/artagon-workflow-test-bazel/dispatches \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -f "event_type=$EVENT_TYPE" \
            -f "client_payload[repository]=${{ github.repository }}" \
            -f "client_payload[ref]=${{ github.ref }}" \
            -f "client_payload[sha]=${{ github.sha }}"
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_DISPATCH_TOKEN }}

  trigger-rust:
    name: Trigger Rust Test Repo
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Trigger artagon-workflow-test-rust
        run: |
          EVENT_TYPE="${{ inputs.event_type || 'workflow-updated' }}"
          if [ "${{ github.event_name }}" = "release" ]; then
            EVENT_TYPE="release-published"
          fi

          echo "Triggering artagon-workflow-test-rust with event: $EVENT_TYPE"

          gh api repos/artagon/artagon-workflow-test-rust/dispatches \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -f "event_type=$EVENT_TYPE" \
            -f "client_payload[repository]=${{ github.repository }}" \
            -f "client_payload[ref]=${{ github.ref }}" \
            -f "client_payload[sha]=${{ github.sha }}"
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_DISPATCH_TOKEN }}

  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [trigger-maven, trigger-cmake, trigger-bazel, trigger-rust]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## Test Repository Triggers" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Triggered all test repositories with event: ${{ inputs.event_type || 'workflow-updated' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repositories:**" >> $GITHUB_STEP_SUMMARY
          echo "- [artagon-workflow-test-maven](https://github.com/artagon/artagon-workflow-test-maven)" >> $GITHUB_STEP_SUMMARY
          echo "- [artagon-workflow-test-cmake](https://github.com/artagon/artagon-workflow-test-cmake)" >> $GITHUB_STEP_SUMMARY
          echo "- [artagon-workflow-test-bazel](https://github.com/artagon/artagon-workflow-test-bazel)" >> $GITHUB_STEP_SUMMARY
          echo "- [artagon-workflow-test-rust](https://github.com/artagon/artagon-workflow-test-rust)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Event Details:**" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Ref:** ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "- **SHA:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
