name: Maven Build (Reusable)

on:
  workflow_call:
    inputs:
      java-version:
        description: 'Java version to use'
        required: false
        type: string
        default: '25'
      java-distribution:
        description: 'Java distribution'
        required: false
        type: string
        default: 'temurin'
      maven-args:
        description: 'Additional Maven arguments'
        required: false
        type: string
        default: ''
      run-tests:
        description: 'Whether to run tests'
        required: false
        type: boolean
        default: true
      run-integration-tests:
        description: 'Whether to run integration tests'
        required: false
        type: boolean
        default: false
      cache-key-prefix:
        description: 'Cache key prefix'
        required: false
        type: string
        default: 'maven'
    outputs:
      build-version:
        description: 'The project version that was built'
        value: ${{ jobs.build.outputs.version }}

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read       # Checkout code
      packages: read       # Download artifacts (if needed)

    outputs:
      version: ${{ steps.get-version.outputs.version }}

    steps:
      - name: Checkout code
        # actions/checkout@v4.2.2
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Set up JDK ${{ inputs.java-version }}
        # actions/setup-java@v4.5.0
        uses: actions/setup-java@8df1039502a15bceb9433410b1a100fbe190c53b
        with:
          java-version: ${{ inputs.java-version }}
          distribution: ${{ inputs.java-distribution }}
          cache: 'maven'

      - name: Cache Maven packages
        # actions/cache@v4.2.0
        uses: actions/cache@1bd1e32a3bdc45362d1e726936510720a7c30a57
        with:
          path: ~/.m2/repository
          key: ${{ inputs.cache-key-prefix }}-${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ inputs.cache-key-prefix }}-${{ runner.os }}-maven-

      - name: Get project version
        id: get-version
        run: |
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Project version: $VERSION"

      - name: Validate inputs
        run: |
          set -euo pipefail

          MAVEN_ARGS="${{ inputs.maven-args }}"
          if ! echo "$MAVEN_ARGS" | grep -qE '^[-A-Za-z0-9=.,_:/ ]*$'; then
            echo "❌ Invalid maven-args: $MAVEN_ARGS"
            echo "Allowed characters: letters, numbers, space, hyphen, underscore, dot, slash, colon, equals, comma"
            exit 1
          fi

          CACHE_PREFIX="${{ inputs.cache-key-prefix }}"
          if [ -n "$CACHE_PREFIX" ] && ! echo "$CACHE_PREFIX" | grep -qE '^[A-Za-z0-9._-]+$'; then
            echo "❌ Invalid cache-key-prefix: $CACHE_PREFIX"
            echo "Allowed characters: letters, numbers, dot, underscore, hyphen"
            exit 1
          fi

          echo "✅ Input validation passed"

      - name: Build with Maven (Skip Tests)
        if: ${{ !inputs.run-tests }}
        run: mvn clean verify -DskipTests ${{ inputs.maven-args }}

      - name: Build with Maven (With Tests)
        if: ${{ inputs.run-tests && !inputs.run-integration-tests }}
        run: mvn clean verify ${{ inputs.maven-args }}

      - name: Build with Maven (With Integration Tests)
        if: ${{ inputs.run-tests && inputs.run-integration-tests }}
        run: mvn clean verify -Partagon-oss-ci ${{ inputs.maven-args }}

      - name: Upload build artifacts
        if: success()
        # actions/upload-artifact@v4.4.3
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882
        with:
          name: build-artifacts
          path: |
            **/target/*.jar
            **/target/*.pom
          retention-days: 7

      - name: Upload test results
        if: always() && inputs.run-tests
        # actions/upload-artifact@v4.4.3
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882
        with:
          name: test-results
          path: |
            **/target/surefire-reports/*.xml
            **/target/failsafe-reports/*.xml
          retention-days: 7
