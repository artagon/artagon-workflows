name: Maven Build (Reusable)

on:
  workflow_call:
    inputs:
      java-version:
        description: 'Java version to use'
        required: false
        type: string
        default: '25'
      java-distribution:
        description: 'Java distribution'
        required: false
        type: string
        default: 'temurin'
      maven-args:
        description: 'Additional Maven arguments'
        required: false
        type: string
        default: ''
      run-tests:
        description: 'Whether to run tests'
        required: false
        type: boolean
        default: true
      run-integration-tests:
        description: 'Whether to run integration tests'
        required: false
        type: boolean
        default: false
      cache-key-prefix:
        description: 'Cache key prefix'
        required: false
        type: string
        default: 'maven'
    outputs:
      build-version:
        description: 'The project version that was built'
        value: ${{ jobs.build.outputs.version }}

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ inputs.java-version }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ inputs.java-version }}
          distribution: ${{ inputs.java-distribution }}
          cache: 'maven'

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ inputs.cache-key-prefix }}-${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ inputs.cache-key-prefix }}-${{ runner.os }}-maven-

      - name: Get project version
        id: get-version
        run: |
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Project version: $VERSION"

      - name: Build with Maven (Skip Tests)
        if: ${{ !inputs.run-tests }}
        run: mvn clean verify -DskipTests ${{ inputs.maven-args }}

      - name: Build with Maven (With Tests)
        if: ${{ inputs.run-tests && !inputs.run-integration-tests }}
        run: mvn clean verify ${{ inputs.maven-args }}

      - name: Build with Maven (With Integration Tests)
        if: ${{ inputs.run-tests && inputs.run-integration-tests }}
        run: mvn clean verify -Partagon-oss-ci ${{ inputs.maven-args }}

      - name: Upload build artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            **/target/*.jar
            **/target/*.pom
          retention-days: 7

      - name: Upload test results
        if: always() && inputs.run-tests
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            **/target/surefire-reports/*.xml
            **/target/failsafe-reports/*.xml
          retention-days: 7
