# Reusable CI Workflow for C++ Projects
#
# Usage in your project's .github/workflows/ci.yml:
#
# name: CI
# on: [push, pull_request]
# jobs:
#   ci:
#     uses: artagon/artagon-common/.github/workflows/cpp-ci.yml@main
#     with:
#       cxx-standard: '23'
#     secrets: inherit

name: C++ Project CI

on:
  workflow_call:
    inputs:
      cmake-options:
        description: 'Additional CMake configuration options'
        required: false
        type: string
        default: ''
      enable-coverage:
        description: 'Enable code coverage reporting'
        required: false
        type: boolean
        default: true
      enable-sanitizers:
        description: 'Enable sanitizer builds'
        required: false
        type: boolean
        default: true
      cxx-standard:
        description: 'C++ standard version (17, 20, 23, 26)'
        required: false
        type: string
        default: '23'
      test-standards:
        description: 'Test multiple C++ standards (comma-separated: 17,20,23,26)'
        required: false
        type: string
        default: ''

env:
  BUILD_TYPE: Release

jobs:
  validate-inputs:
    name: Validate Inputs
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Check workflow inputs
        run: |
          set -euo pipefail

          CMAKE_OPTS="${{ inputs.cmake-options }}"
          if ! echo "$CMAKE_OPTS" | grep -qE '^[-A-Za-z0-9_./=:," ]*$'; then
            echo "❌ Invalid cmake-options: $CMAKE_OPTS"
            echo "Allowed characters: letters, numbers, space, dash, underscore, dot, slash, colon, equals, comma, double quotes"
            exit 1
          fi

          CXX_STANDARD="${{ inputs.cxx-standard }}"
          if ! echo "$CXX_STANDARD" | grep -qE '^(17|20|23|26)$'; then
            echo "❌ Invalid cxx-standard: $CXX_STANDARD"
            echo "Allowed values: 17, 20, 23, 26"
            exit 1
          fi

          TEST_STANDARDS="${{ inputs.test-standards }}"
          if [ -n "$TEST_STANDARDS" ] && ! echo "$TEST_STANDARDS" | grep -qE '^[0-9, ]+$'; then
            echo "❌ Invalid test-standards: $TEST_STANDARDS"
            echo "Allowed characters: digits, commas, spaces"
            exit 1
          fi

          echo "✅ Input validation passed"

  build-linux:
    name: Build (${{ matrix.os }}, ${{ matrix.compiler }}, C++${{ matrix.std }})
    runs-on: ${{ matrix.os }}
    needs: validate-inputs
    permissions:
      contents: read
      packages: read
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        compiler: [gcc, clang]
        std: ${{ fromJson(inputs.test-standards != '' && format('[{0}]', inputs.test-standards) || format('[{0}]', inputs.cxx-standard)) }}
        include:
          - compiler: gcc
            cc: gcc-13
            cxx: g++-13
          - compiler: clang
            cc: clang-18
            cxx: clang++-18

    steps:
      - name: Checkout code
        # actions/checkout@v4.2.2
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          submodules: recursive

      - name: Check for Nix
        id: check-nix
        run: |
          if [ -f "flake.nix" ]; then
            echo "has_nix=true" >> $GITHUB_OUTPUT
          else
            echo "has_nix=false" >> $GITHUB_OUTPUT
          fi

      - name: Install Nix
        if: steps.check-nix.outputs.has_nix == 'true'
        # cachix/install-nix-action@v31.9.0
        uses: cachix/install-nix-action@4e002c8ec80594ecd40e759629461e26c8abed15
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake ninja-build \
            gcc-13 g++-13 \
            clang-18 clang-tools-18 clang-tidy-18 clang-format-18 \
            cppcheck valgrind lcov doxygen graphviz

      - name: Configure CMake
        env:
          CC: ${{ matrix.cc }}
          CXX: ${{ matrix.cxx }}
        run: |
          cmake -B build \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DCMAKE_CXX_COMPILER=${{ matrix.cxx }} \
            -DCMAKE_CXX_STANDARD=${{ matrix.std }} \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
            ${{ inputs.cmake-options }}

      - name: Build
        run: cmake --build build --config ${{ env.BUILD_TYPE }} -j $(nproc)

      - name: Run tests
        working-directory: build
        run: ctest --output-on-failure --verbose

      - name: Static analysis (clang-tidy)
        if: matrix.compiler == 'clang' && matrix.std == inputs.cxx-standard
        continue-on-error: true
        run: |
          if [ -f .clang-tidy ]; then
            find src -name '*.cpp' -exec clang-tidy-18 -p build {} \;
          fi

      - name: Static analysis (cppcheck)
        if: matrix.compiler == 'gcc' && matrix.std == inputs.cxx-standard
        continue-on-error: true
        run: |
          cppcheck --enable=all --std=c++${{ matrix.std }} \
            --suppress=missingIncludeSystem \
            --inline-suppr -I include src/ 2>&1 | tee cppcheck.log

      - name: Upload build artifacts
        # actions/upload-artifact@v4.4.3
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882
        with:
          name: build-${{ matrix.os }}-${{ matrix.compiler }}-cpp${{ matrix.std }}
          path: |
            build/bin/
            build/lib/
          retention-days: 7

  code-coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    needs: validate-inputs
    permissions:
      contents: read
      packages: read
    if: inputs.enable-coverage

    steps:
      - name: Checkout code
        # actions/checkout@v4.2.2
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build g++-13 lcov

      - name: Configure with coverage
        run: |
          cmake -B build \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_CXX_COMPILER=g++-13 \
            -DCMAKE_CXX_STANDARD=${{ inputs.cxx-standard }} \
            -DCMAKE_CXX_FLAGS="--coverage -fprofile-arcs -ftest-coverage" \
            ${{ inputs.cmake-options }}

      - name: Build
        run: cmake --build build -j $(nproc)

      - name: Run tests
        working-directory: build
        run: ctest --output-on-failure

      - name: Generate coverage
        continue-on-error: true
        run: |
          lcov --directory . --capture --output-file coverage.info --ignore-errors empty
          lcov --remove coverage.info '/usr/*' '*/test/*' '*/tests/*' --output-file coverage.info --ignore-errors unused || true
          lcov --list coverage.info || true

      - name: Upload to Codecov
        # codecov/codecov-action@v5.0.7
        uses: codecov/codecov-action@015f24e6818733317a2da2edd6290ab26238649a
        with:
          files: ./coverage.info
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

  sanitizers:
    name: Sanitizers (${{ matrix.sanitizer }})
    runs-on: ubuntu-latest
    needs: validate-inputs
    permissions:
      contents: read
      packages: read
    if: inputs.enable-sanitizers
    strategy:
      fail-fast: false
      matrix:
        sanitizer: [address, undefined, thread, memory]

    steps:
      - name: Checkout code
        # actions/checkout@v4.2.2
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build clang-18 libc++-18-dev libc++abi-18-dev

      - name: Configure with sanitizer
        run: |
          SANITIZER_FLAGS="-fsanitize=${{ matrix.sanitizer }} -fno-omit-frame-pointer -g"

          # Memory sanitizer needs libc++ and clang for both C and C++
          if [ "${{ matrix.sanitizer }}" = "memory" ]; then
            SANITIZER_FLAGS="$SANITIZER_FLAGS -stdlib=libc++"
            CMAKE_C_COMPILER="-DCMAKE_C_COMPILER=clang-18"
          else
            CMAKE_C_COMPILER=""
          fi

          cmake -B build \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_CXX_COMPILER=clang++-18 \
            $CMAKE_C_COMPILER \
            -DCMAKE_CXX_STANDARD=${{ inputs.cxx-standard }} \
            -DCMAKE_CXX_FLAGS="$SANITIZER_FLAGS" \
            -DCMAKE_EXE_LINKER_FLAGS="$SANITIZER_FLAGS" \
            ${{ inputs.cmake-options }}

      - name: Build
        run: cmake --build build -j $(nproc)

      - name: Run tests
        working-directory: build
        env:
          ASAN_OPTIONS: detect_leaks=1:check_initialization_order=1:strict_init_order=1
          UBSAN_OPTIONS: print_stacktrace=1:halt_on_error=1
          TSAN_OPTIONS: second_deadlock_stack=1
          MSAN_OPTIONS: poison_in_dtor=1
        run: ctest --output-on-failure

  valgrind:
    name: Memory Check (Valgrind)
    runs-on: ubuntu-latest
    needs: validate-inputs
    permissions:
      contents: read
      packages: read

    steps:
      - name: Checkout code
        # actions/checkout@v4.2.2
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build g++-13 valgrind

      - name: Configure CMake
        run: |
          cmake -B build \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_CXX_COMPILER=g++-13 \
            -DCMAKE_CXX_STANDARD=${{ inputs.cxx-standard }} \
            ${{ inputs.cmake-options }}

      - name: Build
        run: cmake --build build -j $(nproc)

      - name: Run Valgrind
        working-directory: build
        continue-on-error: true
        run: ctest -T memcheck --output-on-failure

  format-check:
    name: Format Check
    runs-on: ubuntu-latest
    needs: validate-inputs
    permissions:
      contents: read

    steps:
      - name: Checkout code
        # actions/checkout@v4.2.2
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Install clang-format
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format-18

      - name: Check formatting
        run: |
          if [ -f .clang-format ]; then
            find src include -type f \( -name '*.cpp' -o -name '*.hpp' -o -name '*.h' \) \
              -exec clang-format-18 --dry-run --Werror {} \;
          fi

  build-docs:
    name: Build Documentation
    runs-on: ubuntu-latest
    needs: validate-inputs
    permissions:
      contents: read

    steps:
      - name: Checkout code
        # actions/checkout@v4.2.2
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Install Doxygen
        run: |
          sudo apt-get update
          sudo apt-get install -y doxygen graphviz

      - name: Generate documentation
        run: |
          if [ -f Doxyfile ]; then
            doxygen Doxyfile
          elif [ -f docs/Doxyfile ]; then
            cd docs && doxygen Doxyfile
          fi

      - name: Upload documentation
        # actions/upload-artifact@v4.4.3
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882
        if: always()
        with:
          name: documentation
          path: docs/html/
          retention-days: 7
