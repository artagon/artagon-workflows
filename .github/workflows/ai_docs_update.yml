# Reusable AI-Powered Documentation Update Workflow
#
# Detects outdated documentation and generates updates based on code changes.
#
# Usage in your project's .github/workflows/docs-update.yml:
#
# name: AI Docs Update
# on:
#   push:
#     branches: [main]
#     paths:
#       - 'src/**'
#       - 'lib/**'
# jobs:
#   update-docs:
#     uses: artagon/artagon-workflows/.github/workflows/ai_docs_update.yml@main
#     with:
#       ai-provider: 'claude'
#       doc-files: 'README.md,docs/**/*.md'
#     secrets:
#       ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

name: AI Documentation Update

on:
  workflow_call:
    inputs:
      ai-provider:
        description: 'AI provider (claude, openai, gemini)'
        required: false
        type: string
        default: 'claude'
      ai-model:
        description: 'Specific model to use'
        required: false
        type: string
        default: ''
      doc-files:
        description: 'Documentation files to check (comma-separated glob patterns)'
        required: false
        type: string
        default: 'README.md,docs/**/*.md,CHANGELOG.md'
      source-files:
        description: 'Source files to compare against (comma-separated glob patterns)'
        required: false
        type: string
        default: 'src/**/*,lib/**/*'
      compare-ref:
        description: 'Git ref to compare against (e.g., HEAD~10, main)'
        required: false
        type: string
        default: 'HEAD~10'
      create-pr:
        description: 'Create PR with updates'
        required: false
        type: boolean
        default: true
      dry-run:
        description: 'Show updates without applying'
        required: false
        type: boolean
        default: false
      auto-merge:
        description: 'Auto-merge PR if checks pass'
        required: false
        type: boolean
        default: false
      update-threshold:
        description: 'Minimum confidence threshold for updates (0-100)'
        required: false
        type: number
        default: 70
    secrets:
      ANTHROPIC_API_KEY:
        required: false
      OPENAI_API_KEY:
        required: false
      GOOGLE_AI_API_KEY:
        required: false

jobs:
  validate-inputs:
    name: Validate Inputs
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      model: ${{ steps.set-model.outputs.model }}
    steps:
      - name: Validate inputs
        run: |
          set -euo pipefail

          PROVIDER="${{ inputs.ai-provider }}"
          if ! echo "$PROVIDER" | grep -qE '^(claude|openai|gemini)$'; then
            echo "Invalid provider: $PROVIDER"
            exit 1
          fi

      - name: Set model
        id: set-model
        run: |
          PROVIDER="${{ inputs.ai-provider }}"
          MODEL="${{ inputs.ai-model }}"

          if [ -z "$MODEL" ]; then
            case "$PROVIDER" in
              claude) MODEL="claude-opus-4-5-20251101" ;;
              openai) MODEL="gpt-4.1-2025-04-14" ;;
              gemini) MODEL="gemini-2.5-pro-preview-05-06" ;;
            esac
          fi

          echo "model=$MODEL" >> $GITHUB_OUTPUT

  detect-changes:
    name: Detect Code Changes
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      has_changes: ${{ steps.changes.outputs.has_changes }}
      changed_files: ${{ steps.changes.outputs.changed_files }}
    steps:
      - name: Checkout code
        # actions/checkout@v4.2.2
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          fetch-depth: 0

      - name: Detect source code changes
        id: changes
        run: |
          set -euo pipefail

          COMPARE_REF="${{ inputs.compare-ref }}"

          # Get changed source files
          git diff --name-only "$COMPARE_REF" HEAD -- \
            '*.js' '*.ts' '*.py' '*.rs' '*.go' '*.java' '*.c' '*.cpp' '*.h' '*.hpp' \
            | head -50 > changed_source.txt || true

          CHANGED_COUNT=$(wc -l < changed_source.txt | tr -d ' ')

          if [ "$CHANGED_COUNT" -gt 0 ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "changed_files=$CHANGED_COUNT" >> $GITHUB_OUTPUT
            echo "Found $CHANGED_COUNT changed source files"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "changed_files=0" >> $GITHUB_OUTPUT
            echo "No source file changes detected"
          fi

      - name: Upload changed files list
        # actions/upload-artifact@v4.4.3
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882
        with:
          name: changed-source-files
          path: changed_source.txt
          retention-days: 1

  analyze-docs:
    name: Analyze Documentation
    runs-on: ubuntu-latest
    needs: [validate-inputs, detect-changes]
    if: needs.detect-changes.outputs.has_changes == 'true'
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout code
        # actions/checkout@v4.2.2
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          fetch-depth: 0

      - name: Download changed files list
        # actions/download-artifact@v4.1.8
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16
        with:
          name: changed-source-files

      - name: Gather documentation
        id: docs
        run: |
          set -euo pipefail

          # Find documentation files
          DOC_PATTERNS="${{ inputs.doc-files }}"

          > doc_files.txt
          IFS=',' read -ra PATTERNS <<< "$DOC_PATTERNS"
          for pattern in "${PATTERNS[@]}"; do
            pattern=$(echo "$pattern" | xargs)  # trim whitespace
            find . -path "./$pattern" -type f 2>/dev/null >> doc_files.txt || true
          done

          DOC_COUNT=$(wc -l < doc_files.txt | tr -d ' ')
          echo "doc_count=$DOC_COUNT" >> $GITHUB_OUTPUT
          echo "Found $DOC_COUNT documentation files"

          # Collect doc content
          mkdir -p doc_content
          while IFS= read -r doc; do
            [ -z "$doc" ] && continue
            [ ! -f "$doc" ] && continue
            BASENAME=$(basename "$doc" | tr '/' '_')
            head -200 "$doc" > "doc_content/$BASENAME.txt" 2>/dev/null || true
          done < doc_files.txt

      - name: Gather code changes
        run: |
          set -euo pipefail

          COMPARE_REF="${{ inputs.compare-ref }}"

          # Get diff content
          git diff "$COMPARE_REF" HEAD -- \
            '*.js' '*.ts' '*.py' '*.rs' '*.go' '*.java' '*.c' '*.cpp' \
            | head -3000 > code_diff.txt || true

          # Get changed file contents
          mkdir -p changed_content
          while IFS= read -r file; do
            [ -z "$file" ] && continue
            [ ! -f "$file" ] && continue
            BASENAME=$(basename "$file")
            head -100 "$file" > "changed_content/$BASENAME.txt" 2>/dev/null || true
          done < changed_source.txt

      - name: Analyze with Claude
        if: inputs.ai-provider == 'claude'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          set -euo pipefail

          if [ -z "$ANTHROPIC_API_KEY" ]; then
            echo "ANTHROPIC_API_KEY not set"
            exit 1
          fi

          MODEL="${{ needs.validate-inputs.outputs.model }}"
          THRESHOLD="${{ inputs.update-threshold }}"

          # Gather context
          DOC_CONTENT=$(cat doc_content/*.txt 2>/dev/null | head -2000 || echo "No docs found")
          CODE_DIFF=$(cat code_diff.txt | head -2000)
          CHANGED_CODE=$(cat changed_content/*.txt 2>/dev/null | head -1000 || echo "")

          jq -n \
            --arg model "$MODEL" \
            --arg threshold "$THRESHOLD" \
            --arg docs "$DOC_CONTENT" \
            --arg diff "$CODE_DIFF" \
            --arg code "$CHANGED_CODE" \
            '{
              model: $model,
              max_tokens: 4000,
              messages: [{
                role: "user",
                content: ("You are a documentation specialist. Analyze if documentation needs updating based on code changes.\n\nCurrent documentation:\n" + $docs + "\n\nCode changes (diff):\n```diff\n" + $diff + "\n```\n\nChanged code content:\n```\n" + $code + "\n```\n\nAnalyze and respond with JSON:\n{\n  \"needs_update\": true/false,\n  \"confidence\": 0-100,\n  \"outdated_sections\": [\n    {\n      \"file\": \"path/to/doc.md\",\n      \"section\": \"Section name\",\n      \"reason\": \"Why it is outdated\",\n      \"suggested_update\": \"The updated content\"\n    }\n  ],\n  \"new_sections_needed\": [\n    {\n      \"file\": \"path/to/doc.md\",\n      \"title\": \"New section title\",\n      \"content\": \"Suggested content\"\n    }\n  ],\n  \"summary\": \"Brief summary of what needs updating\"\n}\n\nOnly suggest updates with confidence >= " + $threshold + ".")
              }]
            }' > request.json

          curl -s -X POST "https://api.anthropic.com/v1/messages" \
            -H "Content-Type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -d @request.json > response.json

          jq -r '.content[0].text' response.json > analysis.json

      - name: Analyze with OpenAI
        if: inputs.ai-provider == 'openai'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          set -euo pipefail

          if [ -z "$OPENAI_API_KEY" ]; then
            echo "OPENAI_API_KEY not set"
            exit 1
          fi

          MODEL="${{ needs.validate-inputs.outputs.model }}"
          THRESHOLD="${{ inputs.update-threshold }}"

          DOC_CONTENT=$(cat doc_content/*.txt 2>/dev/null | head -2000 || echo "No docs")
          CODE_DIFF=$(cat code_diff.txt | head -2000)

          jq -n \
            --arg model "$MODEL" \
            --arg threshold "$THRESHOLD" \
            --arg docs "$DOC_CONTENT" \
            --arg diff "$CODE_DIFF" \
            '{
              model: $model,
              max_tokens: 4000,
              response_format: { type: "json_object" },
              messages: [{
                role: "system",
                content: "You analyze if documentation needs updating. Respond with JSON: {needs_update, confidence, outdated_sections, new_sections_needed, summary}"
              }, {
                role: "user",
                content: ("Docs:\n" + $docs + "\n\nCode diff:\n```diff\n" + $diff + "\n```\n\nThreshold: " + $threshold)
              }]
            }' > request.json

          curl -s -X POST "https://api.openai.com/v1/chat/completions" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d @request.json > response.json

          jq -r '.choices[0].message.content' response.json > analysis.json

      - name: Analyze with Gemini
        if: inputs.ai-provider == 'gemini'
        env:
          GOOGLE_AI_API_KEY: ${{ secrets.GOOGLE_AI_API_KEY }}
        run: |
          set -euo pipefail

          if [ -z "$GOOGLE_AI_API_KEY" ]; then
            echo "GOOGLE_AI_API_KEY not set"
            exit 1
          fi

          MODEL="${{ needs.validate-inputs.outputs.model }}"
          THRESHOLD="${{ inputs.update-threshold }}"

          DOC_CONTENT=$(cat doc_content/*.txt 2>/dev/null | head -2000 || echo "No docs")
          CODE_DIFF=$(cat code_diff.txt | head -2000)

          jq -n \
            --arg threshold "$THRESHOLD" \
            --arg docs "$DOC_CONTENT" \
            --arg diff "$CODE_DIFF" \
            '{
              contents: [{
                parts: [{
                  text: ("Analyze if docs need updating based on code changes. Threshold: " + $threshold + "\n\nDocs:\n" + $docs + "\n\nDiff:\n```diff\n" + $diff + "\n```\n\nRespond JSON: {needs_update, confidence, outdated_sections, new_sections_needed, summary}")
                }]
              }],
              generationConfig: { responseMimeType: "application/json" }
            }' > request.json

          curl -s -X POST "https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=$GOOGLE_AI_API_KEY" \
            -H "Content-Type: application/json" \
            -d @request.json > response.json

          jq -r '.candidates[0].content.parts[0].text' response.json > analysis.json

      - name: Validate analysis
        id: validate
        run: |
          set -euo pipefail

          if ! jq empty analysis.json 2>/dev/null; then
            echo '{"needs_update": false, "confidence": 0, "summary": "Analysis failed", "outdated_sections": [], "new_sections_needed": []}' > analysis.json
          fi

          NEEDS_UPDATE=$(jq -r '.needs_update // false' analysis.json)
          CONFIDENCE=$(jq -r '.confidence // 0' analysis.json)
          THRESHOLD="${{ inputs.update-threshold }}"

          echo "needs_update=$NEEDS_UPDATE" >> $GITHUB_OUTPUT
          echo "confidence=$CONFIDENCE" >> $GITHUB_OUTPUT

          if [ "$NEEDS_UPDATE" = "true" ] && [ "$CONFIDENCE" -ge "$THRESHOLD" ]; then
            echo "should_update=true" >> $GITHUB_OUTPUT
          else
            echo "should_update=false" >> $GITHUB_OUTPUT
          fi

      - name: Apply updates
        if: inputs.dry-run == false && steps.validate.outputs.should_update == 'true'
        id: apply
        run: |
          set -euo pipefail

          UPDATES_APPLIED=0

          # Apply outdated section updates
          jq -c '.outdated_sections[]?' analysis.json | while IFS= read -r section; do
            [ -z "$section" ] && continue

            FILE=$(echo "$section" | jq -r '.file')
            SUGGESTED=$(echo "$section" | jq -r '.suggested_update')

            if [ -f "$FILE" ] && [ -n "$SUGGESTED" ] && [ "$SUGGESTED" != "null" ]; then
              echo "Would update: $FILE"
              # Note: Actual content replacement would require more sophisticated logic
              # For now, we create a .suggested file
              echo "$SUGGESTED" >> "${FILE}.suggested"
              UPDATES_APPLIED=$((UPDATES_APPLIED + 1))
            fi
          done

          # Add new sections
          jq -c '.new_sections_needed[]?' analysis.json | while IFS= read -r section; do
            [ -z "$section" ] && continue

            FILE=$(echo "$section" | jq -r '.file')
            TITLE=$(echo "$section" | jq -r '.title')
            CONTENT=$(echo "$section" | jq -r '.content')

            if [ -f "$FILE" ] && [ -n "$CONTENT" ] && [ "$CONTENT" != "null" ]; then
              echo "" >> "$FILE"
              echo "## $TITLE" >> "$FILE"
              echo "" >> "$FILE"
              echo "$CONTENT" >> "$FILE"
              UPDATES_APPLIED=$((UPDATES_APPLIED + 1))
              echo "Added section '$TITLE' to $FILE"
            fi
          done

          echo "updates_applied=$UPDATES_APPLIED" >> $GITHUB_OUTPUT

      - name: Show dry-run results
        if: inputs.dry-run == true
        run: |
          echo "## Documentation Update Analysis (Dry Run)" > summary.md
          echo "" >> summary.md

          NEEDS_UPDATE=$(jq -r '.needs_update' analysis.json)
          CONFIDENCE=$(jq -r '.confidence' analysis.json)
          SUMMARY=$(jq -r '.summary' analysis.json)

          echo "**Needs Update**: $NEEDS_UPDATE" >> summary.md
          echo "**Confidence**: $CONFIDENCE%" >> summary.md
          echo "" >> summary.md
          echo "### Summary" >> summary.md
          echo "$SUMMARY" >> summary.md
          echo "" >> summary.md

          echo "### Outdated Sections" >> summary.md
          jq -r '.outdated_sections[]? | "- **\(.file)**: \(.section)\n  - Reason: \(.reason)\n  - Suggestion: \(.suggested_update | .[0:200])..."' analysis.json >> summary.md || echo "None detected" >> summary.md
          echo "" >> summary.md

          echo "### New Sections Needed" >> summary.md
          jq -r '.new_sections_needed[]? | "- **\(.file)**: \(.title)"' analysis.json >> summary.md || echo "None needed" >> summary.md

          cat summary.md

      - name: Create PR with updates
        if: inputs.create-pr == true && inputs.dry-run == false && steps.validate.outputs.should_update == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          # Check if there are changes
          if ! git diff --quiet; then
            BRANCH="ai-docs-update/$(date +%Y%m%d-%H%M%S)"
            SUMMARY=$(jq -r '.summary // "Documentation updates"' analysis.json)

            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"

            git checkout -b "$BRANCH"
            git add -A
            git commit -m "docs: AI-suggested documentation updates

            $SUMMARY

            Generated by AI Documentation Update workflow (${{ inputs.ai-provider }})"

            git push origin "$BRANCH"

            # Create PR
            CONFIDENCE=$(jq -r '.confidence' analysis.json)

            gh pr create \
              --title "docs: AI-suggested documentation updates" \
              --body "## AI Documentation Update

            This PR contains AI-suggested documentation updates based on recent code changes.

            ### Analysis
            - **Provider**: ${{ inputs.ai-provider }} (${{ needs.validate-inputs.outputs.model }})
            - **Confidence**: ${CONFIDENCE}%
            - **Compared against**: ${{ inputs.compare-ref }}

            ### Summary
            $SUMMARY

            ### Outdated Sections Found
            $(jq -r '.outdated_sections[]? | "- \(.file): \(.section)"' analysis.json || echo "None")

            ### Review Notes
            - Please verify all suggested changes
            - AI confidence: ${CONFIDENCE}%
            - Check for accuracy and completeness

            ---
            *Generated by AI Documentation Update workflow*" \
              --base main \
              --head "$BRANCH"
          else
            echo "No changes to commit"
          fi

      - name: Upload analysis artifact
        # actions/upload-artifact@v4.4.3
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882
        with:
          name: docs-update-analysis-${{ github.run_id }}
          path: analysis.json
          retention-days: 30

  no-changes:
    name: No Changes Detected
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'false'
    steps:
      - name: Report no changes
        run: |
          echo "No source code changes detected since ${{ inputs.compare-ref }}"
          echo "Documentation update analysis skipped"
