# CI Workflow - Validate Workflow Changes
#
# This workflow validates changes to reusable workflows by triggering
# test repositories to run their CI with the latest workflow changes.

name: CI

on:
  push:
    branches: [main]
    paths:
      - '.github/workflows/*.yml'
      - '.github/workflows/*.yaml'
      - '!.github/workflows/ci.yml'
      - '!.github/workflows/trigger_test_repos.yml'
      - '!.github/workflows/test_*.yml'
  pull_request:
    paths:
      - '.github/workflows/*.yml'
      - '.github/workflows/*.yaml'
      - '!.github/workflows/ci.yml'
      - '!.github/workflows/trigger_test_repos.yml'
      - '!.github/workflows/test_*.yml'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  detect-changes:
    name: Detect Workflow Changes
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      maven: ${{ steps.filter.outputs.maven }}
      cmake: ${{ steps.filter.outputs.cmake }}
      bazel: ${{ steps.filter.outputs.bazel }}
      any: ${{ steps.filter.outputs.any }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Detect changed workflows
        id: filter
        run: |
          # Get changed files
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          else
            CHANGED_FILES=$(git diff --name-only HEAD^..HEAD)
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Check which workflows changed
          MAVEN_CHANGED=false
          CMAKE_CHANGED=false
          BAZEL_CHANGED=false
          ANY_CHANGED=false

          if echo "$CHANGED_FILES" | grep -q "maven.*\.yml"; then
            MAVEN_CHANGED=true
            ANY_CHANGED=true
          fi

          if echo "$CHANGED_FILES" | grep -q "cmake.*\.yml"; then
            CMAKE_CHANGED=true
            ANY_CHANGED=true
          fi

          if echo "$CHANGED_FILES" | grep -q "bazel.*\.yml"; then
            BAZEL_CHANGED=true
            ANY_CHANGED=true
          fi

          # If any workflow file changed, mark all as changed for comprehensive testing
          if echo "$CHANGED_FILES" | grep -q "\.github/workflows/.*\.yml"; then
            ANY_CHANGED=true
          fi

          echo "maven=$MAVEN_CHANGED" >> $GITHUB_OUTPUT
          echo "cmake=$CMAKE_CHANGED" >> $GITHUB_OUTPUT
          echo "bazel=$BAZEL_CHANGED" >> $GITHUB_OUTPUT
          echo "any=$ANY_CHANGED" >> $GITHUB_OUTPUT

  trigger-maven-tests:
    name: Trigger Maven Tests
    needs: detect-changes
    if: needs.detect-changes.outputs.maven == 'true' || needs.detect-changes.outputs.any == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Trigger artagon-workflow-test-maven
        run: |
          echo "Triggering artagon-workflow-test-maven CI..."

          gh api repos/artagon/artagon-workflow-test-maven/dispatches \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -f "event_type=workflow-updated" \
            -f "client_payload[repository]=${{ github.repository }}" \
            -f "client_payload[ref]=${{ github.ref }}" \
            -f "client_payload[sha]=${{ github.sha }}" \
            -f "client_payload[pr_number]=${{ github.event.pull_request.number }}"

          echo "âœ… Triggered Maven test repository"
          echo "View results: https://github.com/artagon/artagon-workflow-test-maven/actions"
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_DISPATCH_TOKEN }}

  trigger-cmake-tests:
    name: Trigger CMake Tests
    needs: detect-changes
    if: needs.detect-changes.outputs.cmake == 'true' || needs.detect-changes.outputs.any == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Trigger artagon-workflow-test-cmake
        run: |
          echo "Triggering artagon-workflow-test-cmake CI..."

          gh api repos/artagon/artagon-workflow-test-cmake/dispatches \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -f "event_type=workflow-updated" \
            -f "client_payload[repository]=${{ github.repository }}" \
            -f "client_payload[ref]=${{ github.ref }}" \
            -f "client_payload[sha]=${{ github.sha }}" \
            -f "client_payload[pr_number]=${{ github.event.pull_request.number }}"

          echo "âœ… Triggered CMake test repository"
          echo "View results: https://github.com/artagon/artagon-workflow-test-cmake/actions"
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_DISPATCH_TOKEN }}

  trigger-bazel-tests:
    name: Trigger Bazel Tests
    needs: detect-changes
    if: needs.detect-changes.outputs.bazel == 'true' || needs.detect-changes.outputs.any == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Trigger artagon-workflow-test-bazel
        run: |
          echo "Triggering artagon-workflow-test-bazel CI..."

          gh api repos/artagon/artagon-workflow-test-bazel/dispatches \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -f "event_type=workflow-updated" \
            -f "client_payload[repository]=${{ github.repository }}" \
            -f "client_payload[ref]=${{ github.ref }}" \
            -f "client_payload[sha]=${{ github.sha }}" \
            -f "client_payload[pr_number]=${{ github.event.pull_request.number }}"

          echo "âœ… Triggered Bazel test repository"
          echo "View results: https://github.com/artagon/artagon-workflow-test-bazel/actions"
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_DISPATCH_TOKEN }}

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [detect-changes, trigger-maven-tests, trigger-cmake-tests, trigger-bazel-tests]
    if: always() && needs.detect-changes.outputs.any == 'true'
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Generate Summary
        run: |
          echo "## Workflow Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Triggered test repositories to validate workflow changes." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Repositories" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.detect-changes.outputs.maven }}" = "true" ] || [ "${{ needs.detect-changes.outputs.any }}" = "true" ]; then
            echo "- ðŸ”„ [Maven Tests](https://github.com/artagon/artagon-workflow-test-maven/actions) - ${{ needs.trigger-maven-tests.result }}" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.detect-changes.outputs.cmake }}" = "true" ] || [ "${{ needs.detect-changes.outputs.any }}" = "true" ]; then
            echo "- ðŸ”„ [CMake Tests](https://github.com/artagon/artagon-workflow-test-cmake/actions) - ${{ needs.trigger-cmake-tests.result }}" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.detect-changes.outputs.bazel }}" = "true" ] || [ "${{ needs.detect-changes.outputs.any }}" = "true" ]; then
            echo "- ðŸ”„ [Bazel Tests](https://github.com/artagon/artagon-workflow-test-bazel/actions) - ${{ needs.trigger-bazel-tests.result }}" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Monitor test repository CI runs (links above)" >> $GITHUB_STEP_SUMMARY
          echo "2. Verify all tests pass before merging" >> $GITHUB_STEP_SUMMARY
          echo "3. Check for any breaking changes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** Test repositories run independently. Check each repository's Actions tab for detailed results." >> $GITHUB_STEP_SUMMARY

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea
        with:
          script: |
            const body = `## ðŸ” Workflow Validation Triggered

            This PR modifies workflow files. Test repositories have been triggered to validate the changes:

            ### Test Status
            - ðŸ”„ [Maven Tests](https://github.com/artagon/artagon-workflow-test-maven/actions)
            - ðŸ”„ [CMake Tests](https://github.com/artagon/artagon-workflow-test-cmake/actions)
            - ðŸ”„ [Bazel Tests](https://github.com/artagon/artagon-workflow-test-bazel/actions)

            ### What's Next?
            1. Monitor the test repository CI runs (links above)
            2. Verify all tests pass before merging
            3. Check for breaking changes in test results

            **Note:** Test repositories run asynchronously. Click the links above to view detailed test results.

            ---
            _Triggered by commit: ${context.sha.substring(0, 7)}_`;

            // Check if we already commented
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Workflow Validation Triggered')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
