# Reusable Bazel CI Workflow
#
# Usage in your project's .github/workflows/ci.yml:
#
# name: CI
# on: [push, pull_request]
# jobs:
#   ci:
#     uses: artagon/artagon-common/.github/workflows/bazel-ci.yml@main
#     with:
#       bazel-configs: 'release,asan,ubsan'
#     secrets: inherit

name: Bazel Project CI

on:
  workflow_call:
    inputs:
      bazel-version:
        description: 'Bazel version (or "latest")'
        required: false
        type: string
        default: 'latest'
      bazel-configs:
        description: 'Bazel configs to test (comma-separated: release,debug,asan,ubsan,tsan)'
        required: false
        type: string
        default: 'release,debug'
      enable-coverage:
        description: 'Enable code coverage'
        required: false
        type: boolean
        default: true
      targets:
        description: 'Bazel targets to build/test (default: //...)'
        required: false
        type: string
        default: '//...'

env:
  BAZELISK_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  build-test:
    name: Build and Test (${{ matrix.os }}, ${{ matrix.config }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        config: ${{ fromJson(format('[{0}]', inputs.bazel-configs)) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Check for Nix
        id: check-nix
        run: |
          if [ -f "flake.nix" ]; then
            echo "has_nix=true" >> $GITHUB_OUTPUT
          else
            echo "has_nix=false" >> $GITHUB_OUTPUT
          fi

      - name: Install Nix
        if: steps.check-nix.outputs.has_nix == 'true'
        uses: cachix/install-nix-action@v24
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Setup Bazelisk (non-Nix)
        if: steps.check-nix.outputs.has_nix == 'false'
        uses: bazelbuild/setup-bazelisk@v2

      - name: Mount Bazel cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/bazel
            ~/.cache/bazelisk
          key: ${{ runner.os }}-bazel-${{ hashFiles('**/BUILD.bazel', '**/WORKSPACE.bazel', '**/MODULE.bazel') }}
          restore-keys: |
            ${{ runner.os }}-bazel-

      - name: Build with Nix
        if: steps.check-nix.outputs.has_nix == 'true'
        run: |
          nix develop --command bash -c "
            bazel build --config=${{ matrix.config }} ${{ inputs.targets }}
          "

      - name: Build (non-Nix)
        if: steps.check-nix.outputs.has_nix == 'false'
        run: bazel build --config=${{ matrix.config }} ${{ inputs.targets }}

      - name: Test with Nix
        if: steps.check-nix.outputs.has_nix == 'true'
        run: |
          nix develop --command bash -c "
            bazel test --config=${{ matrix.config }} --test_output=errors ${{ inputs.targets }}
          "

      - name: Test (non-Nix)
        if: steps.check-nix.outputs.has_nix == 'false'
        run: bazel test --config=${{ matrix.config }} --test_output=errors ${{ inputs.targets }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.os }}-${{ matrix.config }}
          path: bazel-testlogs/
          retention-days: 7

  build-windows:
    name: Build and Test (Windows)
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Bazelisk
        uses: bazelbuild/setup-bazelisk@v2

      - name: Mount Bazel cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/bazel
            ~/.cache/bazelisk
          key: windows-bazel-${{ hashFiles('**/BUILD.bazel', '**/WORKSPACE.bazel', '**/MODULE.bazel') }}
          restore-keys: |
            windows-bazel-

      - name: Build
        run: bazel build --config=release ${{ inputs.targets }}

      - name: Test
        run: bazel test --config=release --test_output=errors ${{ inputs.targets }}

  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    if: inputs.enable-coverage

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Check for Nix
        id: check-nix
        run: |
          if [ -f "flake.nix" ]; then
            echo "has_nix=true" >> $GITHUB_OUTPUT
          else
            echo "has_nix=false" >> $GITHUB_OUTPUT
          fi

      - name: Install Nix
        if: steps.check-nix.outputs.has_nix == 'true'
        uses: cachix/install-nix-action@v24
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Setup Bazelisk (non-Nix)
        if: steps.check-nix.outputs.has_nix == 'false'
        uses: bazelbuild/setup-bazelisk@v2

      - name: Install lcov
        run: sudo apt-get update && sudo apt-get install -y lcov

      - name: Run coverage with Nix
        if: steps.check-nix.outputs.has_nix == 'true'
        run: |
          nix develop --command bash -c "
            bazel coverage --config=coverage --combined_report=lcov ${{ inputs.targets }}
          "

      - name: Run coverage (non-Nix)
        if: steps.check-nix.outputs.has_nix == 'false'
        run: bazel coverage --config=coverage --combined_report=lcov ${{ inputs.targets }}

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./bazel-out/_coverage/_coverage_report.dat
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

  buildifier:
    name: Buildifier (Format Check)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Buildifier
        run: |
          wget -O /usr/local/bin/buildifier https://github.com/bazelbuild/buildtools/releases/download/v6.4.0/buildifier-linux-amd64
          chmod +x /usr/local/bin/buildifier

      - name: Check formatting
        run: |
          buildifier --lint=warn --mode=check -r .

  bazel-query:
    name: Bazel Query Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bazelisk
        uses: bazelbuild/setup-bazelisk@v2

      - name: Query targets
        run: |
          echo "All buildable targets:"
          bazel query 'kind(".*_binary", //...)' || true
          echo ""
          echo "All test targets:"
          bazel query 'kind(".*_test", //...)' || true

      - name: Analyze dependencies
        run: |
          bazel query --output=graph 'deps(${{ inputs.targets }})' > deps.dot || true

      - name: Upload dependency graph
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-graph
          path: deps.dot
          retention-days: 7
